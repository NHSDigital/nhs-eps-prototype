{% extends './_includes/layout-application.html' %}
{% set primarynav = 'patient' %}
{% set hideNav = 'true' %}
{% set hideJump = 'true' %}
{% set containerClasses = 'patient-search-form-container' %}
{% set versionLimit = 3 %}

{% block pageTitle %}
Find a patient by using advanced details - {{ serviceName }}
{% endblock %}

{% block customStyles %}
<style>
  a {
    cursor: pointer;
    text-decoration: underline;
  }

  @media (min-width: 40.0625em) {
    .patient-search-form .nhsuk-input {
      margin-bottom: 16px;
    }
  }

  .patient-search-form .nhsuk-input {
    margin-bottom: 8px;
  }

  .fieldset {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  .field {
    width: 40px;
  }
  .clear-link {
    margin-top: 10px;
    display: inline-block;
  }
  .date-display {
    margin-top: 10px;
    position: relative;
    display: inline-block;
  }
  .nhsuk-inset-text {
    max-width: 44em;
    margin-bottom: 15px;
    margin-top: 0px;
    padding: 4px;
    border-left: 4px solid #005eb8;
  }

  @media (min-width: 40.0625em){
    .data-panel:first-of-type {
      margin-top: 0px;
    }
  }

  @media (min-width: 40.0625em) {
    .data-panel:last-of-type {
      margin-bottom: 26px;
    }
  }

  .switch-link {
    font-size: 16px;
    font-size: 1rem;
    line-height: 1.5;
    margin-left: 10px;
  }

  .valid-date::after {
    content: url('data:image/svg+xml;utf8,<svg height="16" viewBox="0 0 256 256" width="16" xmlns="http://www.w3.org/2000/svg"><g fill="none" stroke-miterlimit="10" stroke-width="0" transform="matrix(2.81 0 0 2.81 1.406593 1.406593)"><path d="m45 90c-24.813 0-45-20.187-45-45s20.187-45 45-45 45 20.187 45 45-20.187 45-45 45z" fill="%23006747"/><path d="m35.86 69.67-18.36-18.36 9.16-9.16 9.2 9.19 27.48-27.47 9.16 9.16z" fill="%23fff"/></g></svg>');
    position: absolute;
    right: -25px;
    top: 2px;
    width: 18px;
    height: 18px;
  }


</style>
{% endblock %}

{% block beforeContent %}

<div class="above-tab-space">
  <section class="nhsuk-hero">
    <div class="nhsuk-width-container">
      <div class="nhsuk-grid-row">
        <div class="nhsuk-grid-column-two-thirds">
          <div class="nhsuk-hero__wrapper"><h1 class="nhsuk-u-margin-bottom-3">Find a patient</h1></div>
        </div>
      </div>
    </div>
  </section>
</div>

<div class="nhsuk-tab-set find-patient-tabset">
  <div class="find-patient-tabset__container">
    <a href="search" class="nhsuk-tab-set__tab" id="nhs-number-search-tab" type="button">
      <span class="nhsuk-u-visually-hidden">Search by </span>
      By NHS Number
    </a>
    <a href="search-basic" class="nhsuk-tab-set__tab" id="basic-search-tab" type="button">
      <span class="nhsuk-u-visually-hidden">Search by </span>
      By Basic Details
    </a>
    <a href="search-advanced" class="nhsuk-tab-set__tab nhsuk-tab-set__tab--active" id="advanced-search-tab" type="button">
      <span class="nhsuk-u-visually-hidden">Search by </span>
      By Advanced Details
    </a>
    <a href="search-postcode" class="nhsuk-tab-set__tab" id="postcode-search-tab" type="button">
      <span class="nhsuk-u-visually-hidden">Search by </span>
      By Postcode
    </a>
  </div>
</div>

{% endblock %}


{% block content %}

<div class="main-body-wrapper">

  <main style="">

    <div class="patient-search-form">
      <form action="submit-search-advanced" id="advanced-search-form" novalidate="" autocomplete="off" method="POST">
        <h2 class="nhsuk-heading-m nhsuk-u-margin-bottom-1 no-outline" id="advanced-search-label" tabindex="-1">Search by Advanced Details</h2>
        <div class="nhsuk-hint">Enter as many details as you know</div>

        {% if data['version'] !== '3' %}
        <div class="patient-search-form__field-group">
          <div class="nhsuk-form-group">
            <fieldset class="nhsuk-fieldset">
              <legend class="nhsuk-fieldset__legend form-label" id="basic-search-form-gender--label" style="font-weight: 600;">Gender</legend>
              <div class="nhsuk-form-group">
              <div class="nhsuk-form-group">
              <div aria-labelledby="advanced-search-form-gender--label" class="nhsuk-radios nhsuk-radios--inline" id="advanced-search-form-gender">
                <div class="nhsuk-radios__item">
                  <input aria-labelledby="advanced-search-form-gender-1--label" class="nhsuk-radios__input" id="advanced-search-form-gender-1" name="search-gender" type="radio" value="Female" {% if refine === 'true' %} {% if data['search-gender'] === 'Female' %} checked {% endif %} {% endif %}>
                  <label class="nhsuk-label nhsuk-radios__label" for="advanced-search-form-gender-1" id="advanced-search-form-gender-1--label">Female</label>
                </div>
                <div class="nhsuk-radios__item">
                  <input aria-labelledby="advanced-search-form-gender-2--label" class="nhsuk-radios__input" id="advanced-search-form-gender-2" name="search-gender" type="radio" value="Male" {% if refine === 'true' %} {% if data['search-gender'] === 'Male' %} checked {% endif %} {% endif %}>
                  <label class="nhsuk-label nhsuk-radios__label" for="advanced-search-form-gender-2" id="advanced-search-form-gender-2--label">Male</label>
                </div>
                <div class="nhsuk-radios__item">
                  <input aria-labelledby="advanced-search-form-gender-3--label" class="nhsuk-radios__input" id="advanced-search-form-gender-3" name="search-gender" type="radio" value="All" {% if refine === 'true' %} {% if data['search-gender'] === 'All' %} checked {% endif %} {% endif %}>
                  <label class="nhsuk-label nhsuk-radios__label" for="advanced-search-form-gender-3" id="advanced-search-form-gender-3--label">Search all</label>
                </div>
              </div>
              </div>
            </div>
          </fieldset>
        </div>
        {% endif %}



        <div class="patient-search-form__field-group" id="name-form-group">

          {% if data['version'] === '3' %}
          <div class="nhsuk-form-group">
            <label class="nhsuk-label form-label" for="advanced-search-form-surname" id="advanced-search-form-surname--label" style="font-weight: 600;">Last Name</label>
            <input autofocus aria-labelledby="advanced-search-form-surname--label" autocomplete="off" class="nhsuk-input nhsuk-input--width-20" id="advanced-search-form-surname" name="surname" type="text" {% if refine === 'true' %} value="{{ data['surname'] }}" {% endif %}>
          </div>
          {% endif %}

          <div class="nhsuk-form-group">
            <label class="nhsuk-label form-label" for="advanced-search-form-firstname" id="advanced-search-form-firstname--label" style="font-weight: 600;">First Name</label>
            <input aria-labelledby="advanced-search-form-firstname--label" autocomplete="off" class="nhsuk-input nhsuk-input--width-20" id="advanced-search-form-firstname" name="firstname" type="text" {% if refine === 'true' %} value="{{ data['firstname'] }}" {% endif %}>
          </div>

          {% if data['version'] !== '3' %}
          <div class="nhsuk-form-group">
            <label class="nhsuk-label form-label" for="advanced-search-form-surname" id="advanced-search-form-surname--label" style="font-weight: 600;">Last Name</label>
            <input aria-labelledby="advanced-search-form-surname--label" autocomplete="off" class="nhsuk-input nhsuk-input--width-20" id="advanced-search-form-surname" name="surname" type="text" {% if refine === 'true' %} value="{{ data['surname'] }}" {% endif %}>
          </div>
          {% endif %}

          <div class="nhsuk-form-group">
            <div class="nhsuk-checkboxes" id="advanced-search-form-algorithmic">
              <div class="nhsuk-checkboxes__item">
                <input class="nhsuk-checkboxes__input" id="advanced-search-form-algorithmic-2" name="algorithmicSearch" type="checkbox" value="true" {% if refine === 'true' %} {% if data['algorithmicSearch'] === 'true' %} checked {% endif %} {% endif %}>
                <label class="nhsuk-label nhsuk-checkboxes__label" for="advanced-search-form-algorithmic-2" id="advanced-search-form-algorithmic-2--label">Widen search to include similar names and misspellings</label>
              </div>
            </div>
          </div>
        </div>

        {% if data['version'] === '1' %}

        <div class="field-group" id="date-form-group-dob-from-dob-to">
          <div class="nhsuk-form-group">
            <fieldset class="nhsuk-fieldset">
              <legend class="nhsuk-fieldset__legend form-label" id="advanced-search-form-dob-from--label" style="font-weight: 600;">Date of Birth from</legend>
              <div class="patient-search-form__date-group">
                <div class="nhsuk-form-group">
                  <div class="nhsuk-hint nhsuk-u-margin-bottom-1" id="advanced-search-form-dob-from--hint">For example, 31 3 1980</div>
                  <div aria-describedby="advanced-search-form-dob-from--hint" aria-labelledby="advanced-search-form-dob-from--label" class="nhsuk-date-input" id="advanced-search-form-dob-from" novalidate="">
                    <div class="nhsuk-date-input__item">
                      <div class="nhsuk-form-group">
                        <label class="nhsuk-label nhsuk-date-input__label" for="advanced-search-form-dob-from-day" id="advanced-search-form-dob-from-day--label">Day</label>
                        <input aria-labelledby="advanced-search-form-dob-from-day--label" autocomplete="off" class="nhsuk-input nhsuk-date-input__input nhsuk-input--width-2" id="advanced-search-form-dob-from-day" inputmode="numeric" maxlength="2" name="dateFrom-day" pattern="[0-9]*" type="text" {% if refine === 'true' %} value="{{ data['dateFrom-day'] }}"{% endif %}>
                      </div>
                    </div>
                    <div class="nhsuk-date-input__item">
                      <div class="nhsuk-form-group">
                        <label class="nhsuk-label nhsuk-date-input__label" for="advanced-search-form-dob-from-month" id="advanced-search-form-dob-from-month--label">Month</label>
                        <input aria-labelledby="advanced-search-form-dob-from-month--label" autocomplete="off" class="nhsuk-input nhsuk-date-input__input nhsuk-input--width-2" id="advanced-search-form-dob-from-month" inputmode="numeric" maxlength="2" name="dateFrom-month" pattern="[0-9]*" type="text" {% if refine === 'true' %} value="{{ data['dateFrom-month'] }}"{% endif %}>
                      </div>
                    </div>
                    <div class="nhsuk-date-input__item">
                      <div class="nhsuk-form-group">
                        <label class="nhsuk-label nhsuk-date-input__label" for="advanced-search-form-dob-from-year" id="advanced-search-form-dob-from-year--label">Year</label>
                        <input aria-labelledby="advanced-search-form-dob-from-year--label" autocomplete="off" class="nhsuk-input nhsuk-date-input__input nhsuk-input--width-4" id="advanced-search-form-dob-from-year" inputmode="numeric" maxlength="4" name="dateFrom-year" pattern="[0-9]*" type="text" {% if refine === 'true' %} value="{{ data['dateFrom-year'] }}"{% endif %}>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <a aria-label="Use today's date for the 'Date of Birth from' input" class="nhsuk-u-margin-bottom-4" id="set-to-today-dob-from" role="button" tabindex="0">Use today's date</a>
            </fieldset>
          </div>
          <div class="nhsuk-form-group">
            <fieldset class="nhsuk-fieldset">
              <legend class="nhsuk-fieldset__legend form-label" id="advanced-search-form-dob-to--label" style="font-weight: 600;">Date of Birth to</legend>
              <div class="patient-search-form__date-group">
                <div class="nhsuk-form-group">
                  <div class="nhsuk-hint nhsuk-u-margin-bottom-1" id="advanced-search-form-dob-to--hint">For example, 31 3 1980</div>
                  <div aria-describedby="advanced-search-form-dob-to--hint" aria-labelledby="advanced-search-form-dob-to--label" class="nhsuk-date-input" id="advanced-search-form-dob-to">
                    <div class="nhsuk-date-input__item">
                      <div class="nhsuk-form-group">
                        <label class="nhsuk-label nhsuk-date-input__label" for="advanced-search-form-dob-to-day" id="advanced-search-form-dob-to-day--label">Day</label>
                        <input aria-labelledby="advanced-search-form-dob-to-day--label" autocomplete="off" class="nhsuk-input nhsuk-date-input__input nhsuk-input--width-2" id="advanced-search-form-dob-to-day" inputmode="numeric" maxlength="2" name="dateTo-day" pattern="[0-9]*" type="text" {% if refine === 'true' %} value="{{ data['dateTo-day'] }}"{% endif %}>
                      </div>
                    </div>
                    <div class="nhsuk-date-input__item">
                      <div class="nhsuk-form-group">
                        <label class="nhsuk-label nhsuk-date-input__label" for="advanced-search-form-dob-to-month" id="advanced-search-form-dob-to-month--label">Month</label>
                        <input aria-labelledby="advanced-search-form-dob-to-month--label" autocomplete="off" class="nhsuk-input nhsuk-date-input__input nhsuk-input--width-2" id="advanced-search-form-dob-to-month" inputmode="numeric" maxlength="2" name="dateTo-month" pattern="[0-9]*" type="text" {% if refine === 'true' %} value="{{ data['dateTo-month'] }}"{% endif %}>
                      </div>
                    </div>
                    <div class="nhsuk-date-input__item">
                      <div class="nhsuk-form-group">
                        <label class="nhsuk-label nhsuk-date-input__label" for="advanced-search-form-dob-to-year" id="advanced-search-form-dob-to-year--label">Year</label>
                        <input aria-labelledby="advanced-search-form-dob-to-year--label" autocomplete="off" class="nhsuk-input nhsuk-date-input__input nhsuk-input--width-4" id="advanced-search-form-dob-to-year" inputmode="numeric" maxlength="4" name="dateTo-year" pattern="[0-9]*" type="text" {% if refine === 'true' %} value="{{ data['dateTo-year'] }}"{% endif %}>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <a aria-label="Use today's date for the 'Date of Birth to' input" class="nhsuk-u-margin-bottom-4" id="set-to-today-dob-to" role="button" tabindex="0">Use today's date</a>
            </fieldset>
          </div>
        </div>

        </div>

        {% elif data['version'] === '2' or data['version'] === '3' %}

        <div class="patient-search-form__field-group">

          <div class="nhsuk-form-group" id="form-group-single-3">
            <div aria-describedby="basic-search-form-dob-from--hint" class="nhsuk-date-input" id="basic-search-form-dob-from">
              <div class="nhsuk-date-input__item">
                <div class="nhsuk-form-group">
                  <label class="nhsuk-label nhsuk-date-input__label" for="dob-single-3" id="basic-search-form-dob-from-day--label" style="font-weight: 600;">Date of birth
                    <span class="switch-link">(Switch to <a href="#" id="switch-to-date-range-3a">date range</a> or <a href="#" id="switch-to-age-range-3a">age range</a>)</span></label>
                  <input aria-labelledby="basic-search-form-dob-from-day--label" class="nhsuk-input nhsuk-date-input__input nhsuk-input--width-10" id="dob-single-3" type="text" name="date-of-birth" placeholder="DD/MM/YYYY" {% if refine === 'true' %} value="{{ data['date-of-birth'] }}"{% endif %}>
                </div>
              </div>
            </div>

            <div class="nhsuk-inset-text">
              <div id="formattedDate-single-3" class="date-display">Type or paste in any format</div>
            </div>
          </div>

          <fieldset class="nhsuk-fieldset" id="form-group-date-range-3" style="display: none;">
            <legend class="nhsuk-fieldset__legend nhsuk-fieldset__legend--l">
              <h3 class="nhsuk-fieldset__heading" style="font-size: 19px;">
                Date of birth range
                <span class="switch-link">(Switch to <a href="#" id="switch-to-single-3a">Switch to a single date</a> or <a href="#" id="switch-to-age-range-3b">age range</a>)</span>
              </h3>
            </legend>
            <div class="nhsuk-form-group">
              <div class="nhsuk-date-input" id="basic-search-form-dob-range">
                <div class="nhsuk-date-input__item">
                  <div class="nhsuk-form-group">
                    <label class="nhsuk-label nhsuk-date-input__label" for="dob-range-3-from" id="basic-search-form-dob-from-day--label">Date from</label>
                    <input aria-labelledby="basic-search-form-dob-from-day--label" class="nhsuk-input nhsuk-date-input__input nhsuk-input--width-20" name="date-of-birth-from" id="dob-range-3-from" type="text" placeholder="DD/MM/YYYY" {% if refine === 'true' %} value="{{ data['date-of-birth-from'] }}"{% endif %}>
                  </div>
                </div>

                <div class="nhsuk-date-input__item">
                  <div class="nhsuk-form-group">
                    <label class="nhsuk-label nhsuk-date-input__label" for="dob-range-3-to" id="basic-search-form-dob-to-day--label">Date to</label>
                    <input aria-labelledby="basic-search-form-dob-to-day--label" class="nhsuk-input nhsuk-date-input__input nhsuk-input--width-20" name="date-of-birth-to" id="dob-range-3-to" type="text" placeholder="DD/MM/YYYY" {% if refine === 'true' %} value="{{ data['date-of-birth-to'] }}"{% endif %}>
                  </div>
                </div>

              </div>

              <div class="nhsuk-inset-text">
                <div id="formattedDate-range-3" class="date-display">Type or paste in any format</div>
              </div>

            </div>
          </fieldset>

          <fieldset class="nhsuk-fieldset" id="form-group-age-range-3" style="display: none;">
            <legend class="nhsuk-fieldset__legend nhsuk-fieldset__legend--l">
              <h3 class="nhsuk-fieldset__heading" style="font-size: 19px;">
                Age range
                <span class="switch-link">(Switch to <a href="#" id="switch-to-single-3b">Switch to a single date</a> or <a href="#" id="switch-to-date-range-3b">date range</a>)</span>
              </h3>
            </legend>
            <div class="nhsuk-form-group">
              <div class="nhsuk-date-input" id="basic-search-form-age-range">
                <div class="nhsuk-date-input__item">
                  <div class="nhsuk-form-group">
                    <label class="nhsuk-label nhsuk-date-input__label" for="age-from" id="basic-search-form-age-from--label">Age from</label>
                    <input aria-labelledby="basic-search-form-dob-from-day--label" class="nhsuk-input nhsuk-date-input__input nhsuk-input--width-5" id="age-from" name="age-from" type="text" {% if refine === 'true' %} value="{{ data['age-from'] }}"{% endif %}>
                  </div>
                </div>

                <div class="nhsuk-date-input__item">
                  <div class="nhsuk-form-group">
                    <label class="nhsuk-label nhsuk-date-input__label" for="age-to" id="basic-search-form-age-to--label">Age to</label>
                    <input aria-labelledby="basic-search-form-dob-to-day--label" class="nhsuk-input nhsuk-date-input__input nhsuk-input--width-5" id="age-to" name="age-to" type="text" {% if refine === 'true' %} value="{{ data['age-to'] }}"{% endif %}>
                  </div>
                </div>

              </div>

              <div class="nhsuk-inset-text">
                <div id="formattedAge-range-3" class="date-display">Type or paste in any format</div>
              </div>

            </div>
          </fieldset>

        </div>

        {% endif %}


        {% if data['version'] === '3' %}
        <div class="patient-search-form__field-group">
          <div class="nhsuk-form-group">
            <fieldset class="nhsuk-fieldset">
              <legend class="nhsuk-fieldset__legend form-label" id="basic-search-form-gender--label" style="font-weight: 600;">Gender</legend>
              <div class="nhsuk-form-group">
                <div class="nhsuk-form-group">
                  <div aria-labelledby="advanced-search-form-gender--label" class="nhsuk-radios nhsuk-radios--inline" id="advanced-search-form-gender">
                    <div class="nhsuk-radios__item">
                      <input aria-labelledby="advanced-search-form-gender-1--label" class="nhsuk-radios__input" id="advanced-search-form-gender-1" name="search-gender" type="radio" value="Female" {% if refine === 'true' %} {% if data['search-gender'] === 'Female' %} checked {% endif %} {% endif %}>
                      <label class="nhsuk-label nhsuk-radios__label" for="advanced-search-form-gender-1" id="advanced-search-form-gender-1--label">Female</label>
                    </div>
                    <div class="nhsuk-radios__item">
                      <input aria-labelledby="advanced-search-form-gender-2--label" class="nhsuk-radios__input" id="advanced-search-form-gender-2" name="search-gender" type="radio" value="Male" {% if refine === 'true' %} {% if data['search-gender'] === 'Male' %} checked {% endif %} {% endif %}>
                      <label class="nhsuk-label nhsuk-radios__label" for="advanced-search-form-gender-2" id="advanced-search-form-gender-2--label">Male</label>
                    </div>
                    <div class="nhsuk-radios__item">
                      <input aria-labelledby="advanced-search-form-gender-3--label" class="nhsuk-radios__input" id="advanced-search-form-gender-3" name="search-gender" type="radio" value="All" {% if refine === 'true' %} {% if data['search-gender'] === 'All' %} checked {% endif %} {% endif %}>
                      <label class="nhsuk-label nhsuk-radios__label" for="advanced-search-form-gender-3" id="advanced-search-form-gender-3--label">Search all</label>
                    </div>
                  </div>
                </div>
              </div>
            </fieldset>
          </div>
          {% endif %}



        {% if data['version'] === '1' %}

        <div class="field-group nhsuk-u-margin-top-4" id="date-form-group-dod-from-dod-to">
          <div class="nhsuk-form-group">
            <fieldset class="nhsuk-fieldset">
              <legend class="nhsuk-fieldset__legend form-label" id="advanced-search-form-dod-from--label" style="font-weight: 600;">Date of Death from</legend>
              <div class="patient-search-form__date-group">
                <div class="nhsuk-form-group">
                  <div class="nhsuk-hint nhsuk-u-margin-bottom-1" id="advanced-search-form-dod-from--hint">For example, 31 3 1980</div>
                  <div aria-describedby="advanced-search-form-dod-from--hint" aria-labelledby="advanced-search-form-dod-from--label" class="nhsuk-date-input" id="advanced-search-form-dod-from" novalidate="">
                    <div class="nhsuk-date-input__item">
                      <div class="nhsuk-form-group">
                        <label class="nhsuk-label nhsuk-date-input__label" for="advanced-search-form-dod-from-day" id="advanced-search-form-dod-from-day--label">Day</label>
                        <input aria-labelledby="advanced-search-form-dod-from-day--label" autocomplete="off" class="nhsuk-input nhsuk-date-input__input nhsuk-input--width-2" id="advanced-search-form-dod-from-day" inputmode="numeric" maxlength="2" name="dateOfDeathFrom-day" pattern="[0-9]*" type="text" {% if refine === 'true' %} value="{{ data['dateOfDeathFrom-day'] }}"{% endif %}>
                      </div>
                    </div>
                    <div class="nhsuk-date-input__item">
                      <div class="nhsuk-form-group">
                        <label class="nhsuk-label nhsuk-date-input__label" for="advanced-search-form-dod-from-month" id="advanced-search-form-dod-from-month--label">Month</label>
                        <input aria-labelledby="advanced-search-form-dod-from-month--label" autocomplete="off" class="nhsuk-input nhsuk-date-input__input nhsuk-input--width-2" id="advanced-search-form-dod-from-month" inputmode="numeric" maxlength="2" name="dateOfDeathFrom-month" pattern="[0-9]*" type="text" {% if refine === 'true' %} value="{{ data['dateOfDeathFrom-day'] }}"{% endif %}>
                      </div>
                    </div>
                    <div class="nhsuk-date-input__item">
                      <div class="nhsuk-form-group">
                        <label class="nhsuk-label nhsuk-date-input__label" for="advanced-search-form-dod-from-year" id="advanced-search-form-dod-from-year--label">Year</label>
                        <input aria-labelledby="advanced-search-form-dod-from-year--label" autocomplete="off" class="nhsuk-input nhsuk-date-input__input nhsuk-input--width-4" id="advanced-search-form-dod-from-year" inputmode="numeric" maxlength="4" name="dateOfDeathFrom-year" pattern="[0-9]*" type="text" {% if refine === 'true' %} value="{{ data['dateOfDeathFrom-day'] }}"{% endif %}>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <a aria-label="Use today's date for the 'Date of Death from' input" class="nhsuk-u-margin-bottom-4" id="set-to-today-dod-from" role="button" tabindex="0">Use today's date</a>
            </fieldset>
          </div>
          <div class="nhsuk-form-group">
            <fieldset class="nhsuk-fieldset">
              <legend class="nhsuk-fieldset__legend form-label" id="advanced-search-form-dod-to--label" style="font-weight: 600;">Date of Death to</legend>
              <div class="patient-search-form__date-group">
                <div class="nhsuk-form-group">
                  <div class="nhsuk-hint nhsuk-u-margin-bottom-1" id="advanced-search-form-dod-to--hint">For example, 31 3 1980</div>
                  <div aria-describedby="advanced-search-form-dod-to--hint" aria-labelledby="advanced-search-form-dod-to--label" class="nhsuk-date-input" id="advanced-search-form-dod-to">
                    <div class="nhsuk-date-input__item">
                      <div class="nhsuk-form-group">
                        <label class="nhsuk-label nhsuk-date-input__label" for="advanced-search-form-dod-to-day" id="advanced-search-form-dod-to-day--label">Day</label>
                        <input aria-labelledby="advanced-search-form-dod-to-day--label" autocomplete="off" class="nhsuk-input nhsuk-date-input__input nhsuk-input--width-2" id="advanced-search-form-dod-to-day" inputmode="numeric" maxlength="2" name="dateOfDeathTo-day" pattern="[0-9]*" type="text" {% if refine === 'true' %} value="{{ data['dateOfDeathTo-day'] }}"{% endif %}>
                      </div>
                    </div>
                    <div class="nhsuk-date-input__item">
                      <div class="nhsuk-form-group">
                        <label class="nhsuk-label nhsuk-date-input__label" for="advanced-search-form-dod-to-month" id="advanced-search-form-dod-to-month--label">Month</label>
                        <input aria-labelledby="advanced-search-form-dod-to-month--label" autocomplete="off" class="nhsuk-input nhsuk-date-input__input nhsuk-input--width-2" id="advanced-search-form-dod-to-month" inputmode="numeric" maxlength="2" name="dateOfDeathTo-month" pattern="[0-9]*" type="text" {% if refine === 'true' %} value="{{ data['dateOfDeathTo-month'] }}"{% endif %}>
                      </div>
                    </div>
                    <div class="nhsuk-date-input__item">
                      <div class="nhsuk-form-group">
                        <label class="nhsuk-label nhsuk-date-input__label" for="advanced-search-form-dod-to-year" id="advanced-search-form-dod-to-year--label">Year</label>
                        <input aria-labelledby="advanced-search-form-dod-to-year--label" autocomplete="off" class="nhsuk-input nhsuk-date-input__input nhsuk-input--width-4" id="advanced-search-form-dod-to-year" inputmode="numeric" maxlength="4" name="dateOfDeathTo-year" pattern="[0-9]*" type="text" {% if refine === 'true' %} value="{{ data['dateOfDeathTo-year'] }}"{% endif %}>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <a aria-label="Use today's date for the 'Date of Death to' input" class="nhsuk-u-margin-bottom-4" id="set-to-today-dod-to" role="button" tabindex="0">Use today's date</a>
            </fieldset>
          </div>
        </div>
        <div class="nhsuk-inset-text" style="margin: 0;">
          <span class="nhsuk-u-visually-hidden">Information: </span>
          <span class="nhsuk-label">Search Range: No dates entered</span>
        </div>

        {% elif data['version'] === '2' or data['version'] === '3' %}

          <div class="patient-search-form__field-group">

            <div class="nhsuk-form-group" id="form-group-dod-single">
              <div aria-describedby="basic-search-form-dob-from--hint" class="nhsuk-date-input" id="basic-search-form-dod-from">
                <div class="nhsuk-date-input__item">
                  <div class="nhsuk-form-group">
                    <label class="nhsuk-label nhsuk-date-input__label" for="dod-single-3" id="basic-search-form-dod-from-day--label" style="font-weight: 600;">Date of death (optional)
                      <span class="switch-link">(<a href="#" id="switch-to-dod-range">Switch to a date range</a>)</span></label>
                    <input aria-labelledby="basic-search-form-dob-from-day--label" class="nhsuk-input nhsuk-date-input__input nhsuk-input--width-10" id="dod-single-3" type="text" name="date-of-death" placeholder="DD/MM/YYYY" {% if refine === 'true' %} value="{{ data['date-of-death'] }}"{% endif %}>

                  </div>
                </div>
              </div>

              <div class="nhsuk-inset-text">
                <div id="formattedDateOfDeath-single-3" class="date-display">Type or paste in any format</div>
              </div>

            </div>

            <fieldset class="nhsuk-fieldset" id="form-group-dod-range" style="display: none;">
              <legend class="nhsuk-fieldset__legend nhsuk-fieldset__legend--l">
                <h3 class="nhsuk-fieldset__heading" style="font-size: 19px;">
                  Date of death range (optional)
                  <span class="switch-link">(<a href="#" id="switch-dod-range">Switch to a single date</a>)</span>
                </h3>
              </legend>
              <div class="nhsuk-form-group">
                <div class="nhsuk-date-input" id="basic-search-form-dod-range">
                  <div class="nhsuk-date-input__item">
                    <div class="nhsuk-form-group">
                      <label class="nhsuk-label nhsuk-date-input__label" for="dod-range-3-from" id="advanced-search-form-dod-from-day--label">Date from</label>
                      <input aria-labelledby="basic-search-form-dob-from-day--label" class="nhsuk-input nhsuk-date-input__input nhsuk-input--width-20" id="dod-range-3-from" name="date-of-death-from" type="text" placeholder="DD/MM/YYYY" {% if refine === 'true' %} value="{{ data['date-of-death-from'] }}"{% endif %}>
                    </div>
                  </div>

                  <div class="nhsuk-date-input__item">
                    <div class="nhsuk-form-group">
                      <label class="nhsuk-label nhsuk-date-input__label" for="dod-range-3-to" id="advanced-search-form-dod-to-day--label">Date to</label>
                      <input aria-labelledby="basic-search-form-dob-to-day--label" class="nhsuk-input nhsuk-date-input__input nhsuk-input--width-20" id="dod-range-3-to" name="date-of-death-to" type="text" placeholder="DD/MM/YYYY" {% if refine === 'true' %} value="{{ data['date-of-death-to'] }}"{% endif %}>
                    </div>
                  </div>

                </div>

                <div class="nhsuk-inset-text">
                  <div id="formattedDateOfDeath-range-3" class="date-display">Enter or paste a date in any format</div>
                </div>

              </div>
            </fieldset>

          </div>

          {% endif %}

          <div class="patient-search-form__field-group" id="postcode-form-group">
            <div class="nhsuk-form-group">
              <label class="nhsuk-label" for="advanced-search-form-postcode" id="advanced-search-form-postcode--label" style="font-weight: 600;">Postcode</label>
              <input aria-labelledby="advanced-search-form-postcode--label" autocomplete="off" class="nhsuk-input nhsuk-input--width-10" id="advanced-search-form-postcode" name="postcode" type="text" {% if refine === 'true' %} value="{{ data['postcode'] }}" {% endif %}>
            </div>
            <details class="nhsuk-details">
              <summary class="nhsuk-details__summary" tabindex="0">
                <span class="nhsuk-details__summary-text">Find an address or postcode</span>
              </summary>
              <div id="postcode-finder-errors"></div>
              <div class="nhsuk-details__text">
                <div class="nhsuk-form-group typeahead-search__form-group">
                  <label class="nhsuk-label" for="address-lookup-search-input" id="address-lookup-search-input--label">Enter part of an address or a postcode</label>
                  <div class="nhsuk-hint" id="address-lookup-search-input--hint">Start typing to search for and select an address. Enter as many details as you know.</div>
                  <div>
                    <a aria-label="Clear Typeahead Input" class="typeahead-search__clear" id="address-lookup-search-input--clear" role="button" tabindex="0">Clear</a>
                    <div class="typeahead-search-container">
                      <div class="nhsuk-form-group nhsuk-u-margin-bottom-0">
                        <input aria-describedby="address-lookup-search-input--hint" aria-labelledby="address-lookup-search-input--label" autocomplete="off" class="nhsuk-input nhsuk-input typeahead-search" debounce="300" id="address-lookup-search-input" name="address-lookup-search-input" showclearlink="1" type="text" value="">
                      </div>
                    </div>
                  </div>
                </div>
                <button aria-disabled="false" class="nhsuk-button nhsuk-button--secondary" id="address-lookup-search-apply" type="button">Select</button>
              </div>
            </details>
          </div>

          <input type="hidden" name="last-search" value="advanced" />
          <input type="hidden" name="dob_fieldset" id="dob_fieldset" value="single" />
          <input type="hidden" name="dod_fieldset" id="dod_fieldset" value="single" />

          <div class="nhsuk-button-group">
            <button aria-disabled="false" class="nhsuk-button patient-search-form__button" type="submit" style="margin-bottom: 16px;margin-top: 24px;">Find a patient</button>
            <a class="nhsuk-link" id="clear-form" href="#">Clear form</a>
          </div>

        </div>

      </form>
    </div>

  </main>

</div>
{% endblock %}

{% block pageScripts %}

<script>
  const placeholderText = 'Type or paste in any format';

  {% if data['version'] === '2' or data['version'] === '3' %}

  // typing or pasting date of birth into a single field

  document.getElementById('dob-single-3').addEventListener('input', function (e) {
    const formattedDate = formatDateString(e.target.value);
    // document.getElementById('formattedDate-single-3').textContent = formattedDate ? formattedDate : placeholderText;
    if (formattedDate) {
      document.getElementById('formattedDate-single-3').textContent = formattedDate;
      document.getElementById('formattedDate-single-3').classList.add('valid-date');
    } else {
      document.getElementById('formattedDate-single-3').textContent = placeholderText;
      document.getElementById('formattedDate-single-3').classList.remove('valid-date');
    }
  });

  document.getElementById('dob-single-3').addEventListener('paste', function (e) {
    e.preventDefault();
    const pastedData = e.clipboardData.getData('text');
    const formattedDate = formatDateString(pastedData);
    if (formattedDate) {
      e.target.value = pastedData;
      document.getElementById('formattedDate-single-3').textContent = formattedDate;
      document.getElementById('formattedDate-single-3').classList.add('valid-date');
    } else {
      document.getElementById('formattedDate-single-3').textContent = placeholderText;
      document.getElementById('formattedDate-single-3').classList.remove('valid-date');
    }
  });

  // typing or pasting into the date of birth range 'from' field

  document.getElementById('dob-range-3-from').addEventListener('input', updateDOBRange);
  document.getElementById('dob-range-3-to').addEventListener('input', updateDOBRange);

  document.getElementById('dob-range-3-from').addEventListener('paste', function (e) {
    e.preventDefault();
    const pastedData = e.clipboardData.getData('text');
    const formattedDate = formatDateString(pastedData);
    if (formattedDate) {
      e.target.value = pastedData;
      updateDOBRange()
      document.getElementById('formattedDate-range-3').classList.add('valid-date');
    } else {
      updateDOBRange()
      document.getElementById('formattedDate-range-3').classList.remove('valid-date');
    }
  });

  document.getElementById('dob-range-3-to').addEventListener('paste', function (e) {
    e.preventDefault();
    const pastedData = e.clipboardData.getData('text');
    const formattedDate = formatDateString(pastedData);
    if (formattedDate) {
      e.target.value = pastedData;
      updateDOBRange()
      document.getElementById('formattedDate-range-3').classList.add('valid-date');
    } else {
      updateDOBRange()
      document.getElementById('formattedDate-range-3').classList.remove('valid-date');
    }
  });

  // typing or pasting into the age  range 'from' field

  document.getElementById('age-from').addEventListener('input', updateAgeRange);
  document.getElementById('age-to').addEventListener('input', updateAgeRange);

  // typing or pasting date of death into a single field

  document.getElementById('dod-single-3').addEventListener('input', function (e) {
    const formattedDate = formatDateString(e.target.value);
    if (formattedDate) {
      document.getElementById('formattedDateOfDeath-single-3').textContent = formattedDate;
      document.getElementById('formattedDateOfDeath-single-3').classList.add('valid-date');
    } else {
      document.getElementById('formattedDateOfDeath-single-3').textContent = placeholderText;
      document.getElementById('formattedDateOfDeath-single-3').classList.remove('valid-date');
    }
  });

  document.getElementById('dod-single-3').addEventListener('paste', function (e) {
    e.preventDefault();
    const pastedData = e.clipboardData.getData('text');
    const formattedDate = formatDateString(pastedData);
    if (formattedDate) {
      e.target.value = pastedData;
      document.getElementById('formattedDateOfDeath-single-3').textContent = formattedDate;
      document.getElementById('formattedDateOfDeath-single-3').classList.add('valid-date');
    } else {
      document.getElementById('formattedDateOfDeath-single-3').textContent = placeholderText;
      document.getElementById('formattedDateOfDeath-single-3').classList.remove('valid-date');
    }
  });

  // typing or pasting into the date of death range 'from' field

  document.getElementById('dod-range-3-from').addEventListener('input', updateDODRange);
  document.getElementById('dod-range-3-to').addEventListener('input', updateDODRange);

  document.getElementById('dod-range-3-from').addEventListener('paste', function (e) {
    e.preventDefault();
    const pastedData = e.clipboardData.getData('text');
    const formattedDate = formatDateString(pastedData);
    if (formattedDate) {
      e.target.value = pastedData;
      updateDODRange()
      document.getElementById('formattedDateOfDeath-range-3').classList.remove('valid-date');
    } else {
      document.getElementById('formattedDateOfDeath-range-3').textContent = placeholderText;
      document.getElementById('formattedDateOfDeath-range-3').classList.add('valid-date');
    }
  });

  // typing or pasting into the date of death range 'to' field

  document.getElementById('dod-range-3-to').addEventListener('paste', function (e) {
    e.preventDefault();
    const pastedData = e.clipboardData.getData('text');
    const formattedDate = formatDateString(pastedData);
    if (formattedDate) {
      e.target.value = pastedData;
      updateDODRange()
      document.getElementById('formattedDateOfDeath-range-3').classList.add('valid-date');
    } else {
      document.getElementById('formattedDateOfDeath-range-3').textContent = placeholderText;
      document.getElementById('formattedDateOfDeath-range-3').classList.remove('valid-date');
    }
  });

  {% endif %}

  function updateAgeRange() {
    const ageFrom = parseInt(document.getElementById('age-from').value, 10);
    const ageTo = parseInt(document.getElementById('age-to').value, 10);
    const dobRangeDiv = document.getElementById('formattedAge-range-3');

    if (isNaN(ageFrom) || isNaN(ageTo) || ageFrom > ageTo) {
      dobRangeDiv.textContent = 'Please enter valid ages.';
      dobRangeDiv.classList.remove('valid-date');
      return;
    }

    const currentDate = new Date();
    const fromDate = new Date(currentDate);
    const toDate = new Date(currentDate);

    fromDate.setFullYear(currentDate.getFullYear() - ageTo);
    toDate.setFullYear(currentDate.getFullYear() - ageFrom);

    const fromDateString = fromDate.toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' });
    const toDateString = toDate.toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' });

    dobRangeDiv.textContent = `Date of birth range: ${fromDateString} - ${toDateString}`;
    dobRangeDiv.classList.add('valid-date');
  }

  function updateDOBRange() {
    const dateFrom = document.getElementById('dob-range-3-from').value;
    const dateTo = document.getElementById('dob-range-3-to').value;
    const dobRangeDiv = document.getElementById('formattedDate-range-3');

    const fromDate = formatDateRange(dateFrom);
    const toDate = formatDateRange(dateTo);

    if (!fromDate && !toDate) {
      dobRangeDiv.textContent = 'Please enter valid dates.';
      dobRangeDiv.classList.remove('valid-date');
      return;
    } else if (!toDate && fromDate.length === 4) {
      dobRangeDiv.textContent = `Date of birth range: All of ${fromDate}`;
      dobRangeDiv.classList.add('valid-date');
      return;
    } else if (fromDate.length === 4 && toDate.length === 4) {
      dobRangeDiv.textContent = `Date of birth range: From 1st Jan ${fromDate} to 31st Dec ${toDate}`;
      dobRangeDiv.classList.add('valid-date');
    } else if (fromDate && toDate.length === 4) {
      dobRangeDiv.textContent = `Date of birth range: From ${fromDate} to 31st Dec ${toDate}`;
      dobRangeDiv.classList.add('valid-date');
    } else if (fromDate.length === 4 && toDate) {
      dobRangeDiv.textContent = `Date of birth range: From 1st Jan ${fromDate} to ${toDate}`;
      dobRangeDiv.classList.add('valid-date');
    } else {
      dobRangeDiv.textContent = `Date of birth range: From ${fromDate} to ${toDate}`;
      dobRangeDiv.classList.add('valid-date');
    }
  }

  function updateDODRange() {
    const dateFrom = document.getElementById('dod-range-3-from').value;
    const dateTo = document.getElementById('dod-range-3-to').value;
    const dobRangeDiv = document.getElementById('formattedDateOfDeath-range-3');

    const fromDate = formatDateRange(dateFrom);
    const toDate = formatDateRange(dateTo);

    if (!fromDate && !toDate) {
      dobRangeDiv.textContent = 'Please enter valid dates.';
      dobRangeDiv.classList.remove('valid-date');
      return;
    } else if (!toDate && fromDate.length === 4) {
      dobRangeDiv.textContent = `Date of birth range: All of ${fromDate}`;
      dobRangeDiv.classList.add('valid-date');
      return;
    } else if (fromDate.length === 4 && toDate.length === 4) {
      dobRangeDiv.textContent = `Date of birth range: From 1st Jan ${fromDate} to 31st Dec ${toDate}`;
      dobRangeDiv.classList.add('valid-date');
    } else if (fromDate && toDate.length === 4) {
      dobRangeDiv.textContent = `Date of birth range: From ${fromDate} to 31st Dec ${toDate}`;
      dobRangeDiv.classList.add('valid-date');
    } else if (fromDate.length === 4 && toDate) {
      dobRangeDiv.textContent = `Date of birth range: From 1st Jan ${fromDate} to ${toDate}`;
      dobRangeDiv.classList.add('valid-date');
    } else {
      dobRangeDiv.textContent = `Date of birth range: From ${fromDate} to ${toDate}`;
      dobRangeDiv.classList.add('valid-date');
    }
  }


  function updateDOBSingle() {
    const date = document.getElementById('dod-single-3').value;
    const dobSingleDiv = document.getElementById('formattedDate-single-3');

    const singleDate = formatDateRange(date);

    if (isNaN(singleDate)) {
      dobSingleDiv.textContent = placeholderText;
      dobSingleDiv.classList.remove('valid-date');
      return;
    }

    const dateString = singleDate.toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' });

    dobSingleDiv.textContent = `${dateString}`;
    dobSingleDiv.classList.add('valid-date');
  }

  function updateFormattedDate(input) {
    const formattedDate = formatDateString(input);
    const formattedDateDiv = document.getElementById('formattedDate');
    if (formattedDate) {
      formattedDateDiv.textContent = formattedDate;
      formattedDateDiv.classList.add('valid-date');
    } else {
      formattedDateDiv.textContent = placeholderText;
      formattedDateDiv.classList.remove('valid-date');
    }
  }

  function parseDate(input) {
    const regexes = [
      /(\d{1,2})[\/\-,\.\s](\d{1,2})[\/\-,\.\s](\d{2,4})/i, // Formats like 04/04/2004, 04-04-2004, 04.04.2004, 04 04 2004
      /(\d{1,2})[\/\-,\.\s](\d{1,2})[\/\-,\.\s](\d{2})/i,    // Formats like 04/04/04, 04-04-04, 04.04.04, 04 04 04
      /(\d{1,2})(?:st|nd|rd|th)?\s+(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)\s+(\d{2,4})/i, // 4th apr 04, 4 apr 2004
      /(\d{1,2})(?:st|nd|rd|th)?\s+(january|february|march|april|may|june|july|august|september|october|november|december)\s+(\d{2,4})/i, // 4th april 04, 4 april 2004
      /(\d{1,2})(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)(\d{2,4})/i, // Formats like 4apr04, 04apr2004
      /(\d{1,2})(january|february|march|april|may|june|july|august|september|october|november|december)(\d{2,4})/i, // 4april04, 04april2004
      /(\d{1,2})-(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)-(\d{4})/i, // Format like 04-Apr-2024
      /(\d{1,2})-(january|february|march|april|may|june|july|august|september|october|november|december)-(\d{2,4})/i, // 4-april-04, 04-april-2004
      /(\d{2})(\d{2})(\d{2,4})/, // Formats like 04042004, 040404
      /^(19|20)\d{2}$/ // Four-digit year starting with 19 or 20
    ];

    for (let regex of regexes) {
      const match = input.match(regex);
      if (match) {
        if (match.length === 2) { // Only year matched
          const year = match[0];
          return { year, isFullYear: true };
        } else {
          let [, day, month, year] = match;
          if (isNaN(month)) {
            const monthNamesFull = ["january", "february", "march", "april", "may", "june", "july", "august", "september", "october", "november", "december"];
            const monthNamesAbbr = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"];
            const monthIndex = monthNamesFull.indexOf(month.toLowerCase()) + 1 || monthNamesAbbr.indexOf(month.toLowerCase()) + 1;
            month = monthIndex.toString().padStart(2, '0');
          } else {
            month = month.padStart(2, '0');
          }
          if (year.length === 2) {
            year = '20' + year;
          }
          day = day.padStart(2, '0');
          return { day, month, year };
        }
      }
    }
    return null;
  }

  function formatDateString(input) {
    const dateParts = parseDate(input);
    if (dateParts) {
      if (dateParts.isFullYear) {
        return `Search all of year ${dateParts.year}`;
      } else {
        const { day, month, year } = dateParts;
        const monthNamesFull = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const monthName = monthNamesFull[parseInt(month) - 1];
        const daySuffix = getDaySuffix(day);
        return `${parseInt(day)}${daySuffix} ${monthName} ${year}`;
      }
    }
    return null;
  }

  function formatDateRange(input) {
    const dateParts = parseDate(input);
    if (dateParts) {
      if (dateParts.isFullYear) {
        return `${dateParts.year}`;
      } else {
        const { day, month, year } = dateParts;
        const monthNamesFull = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const monthName = monthNamesFull[parseInt(month) - 1];
        const daySuffix = getDaySuffix(day);
        return `${parseInt(day)}${daySuffix} ${monthName} ${year}`;
      }
    }
    return null;
  }

  function getDaySuffix(day) {
    const d = parseInt(day);
    if (d >= 11 && d <= 13) {
      return 'th';
    }
    switch (d % 10) {
      case 1: return 'st';
      case 2: return 'nd';
      case 3: return 'rd';
      default: return 'th';
    }
  }

  {% if data['version'] === '1' %}

  // links to set current date on the 4 fields of as-is version

  document.getElementById('set-to-today-dob-from').addEventListener('click', function(e) {
    e.preventDefault();

    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0'); // January is 0!
    const year = today.getFullYear();

    document.getElementById('advanced-search-form-dob-from-day').value = day;
    document.getElementById('advanced-search-form-dob-from-month').value = month;
    document.getElementById('advanced-search-form-dob-from-year').value = year;
  });

  document.getElementById('set-to-today-dob-to').addEventListener('click', function(e) {
    e.preventDefault();

    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0'); // January is 0!
    const year = today.getFullYear();

    document.getElementById('advanced-search-form-dob-to-day').value = day;
    document.getElementById('advanced-search-form-dob-to-month').value = month;
    document.getElementById('advanced-search-form-dob-to-year').value = year;
  });

  document.getElementById('set-to-today-dod-from').addEventListener('click', function(e) {
    e.preventDefault();

    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0'); // January is 0!
    const year = today.getFullYear();

    document.getElementById('advanced-search-form-dod-from-day').value = day;
    document.getElementById('advanced-search-form-dod-from-month').value = month;
    document.getElementById('advanced-search-form-dod-from-year').value = year;
  });

  document.getElementById('set-to-today-dod-to').addEventListener('click', function(e) {
    e.preventDefault();

    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0'); // January is 0!
    const year = today.getFullYear();

    document.getElementById('advanced-search-form-dod-to-day').value = day;
    document.getElementById('advanced-search-form-dod-to-month').value = month;
    document.getElementById('advanced-search-form-dod-to-year').value = year;
  });

  {% elif data['version'] === '2' or data['version'] === '3' %}

  // version 3 has a combined single/date rage/ age range switcher

  // switch from single date to age range
  document.getElementById('switch-to-date-range-3a').addEventListener('click', function(e) {
    e.preventDefault();
    document.getElementById('form-group-single-3').style.display = 'none';
    document.getElementById('form-group-date-range-3').style.display = 'block';
    document.getElementById('dob_fieldset').value = 'date-range';
  });
  document.getElementById('switch-to-date-range-3b').addEventListener('click', function(e) {
    e.preventDefault();
    document.getElementById('form-group-age-range-3').style.display = 'none';
    document.getElementById('form-group-date-range-3').style.display = 'block';
    document.getElementById('dob_fieldset').value = 'date-range';
  });


  document.getElementById('switch-to-age-range-3a').addEventListener('click', function(e) {
    e.preventDefault();
    document.getElementById('form-group-single-3').style.display = 'none';
    document.getElementById('form-group-age-range-3').style.display = 'block';
    document.getElementById('dob_fieldset').value = 'age-range';
  });
  document.getElementById('switch-to-age-range-3b').addEventListener('click', function(e) {
    e.preventDefault();
    document.getElementById('form-group-date-range-3').style.display = 'none';
    document.getElementById('form-group-age-range-3').style.display = 'block';
    document.getElementById('dob_fieldset').value = 'age-range';
  });


  document.getElementById('switch-to-single-3a').addEventListener('click', function(e) {
    e.preventDefault();
    document.getElementById('form-group-date-range-3').style.display = 'none';
    document.getElementById('form-group-single-3').style.display = 'block';
    document.getElementById('dob_fieldset').value = 'single';
  });
  document.getElementById('switch-to-single-3b').addEventListener('click', function(e) {
    e.preventDefault();
    document.getElementById('form-group-age-range-3').style.display = 'none';
    document.getElementById('form-group-single-3').style.display = 'block';
    document.getElementById('dob_fieldset').value = 'single';
  });

  // date of death switcher

  document.getElementById('switch-to-dod-range').addEventListener('click', function(e) {
    e.preventDefault();
    document.getElementById('form-group-dod-single').style.display = 'none';
    document.getElementById('form-group-dod-range').style.display = 'block';
    document.getElementById('dod_fieldset').value = 'date-range';
  });

  document.getElementById('switch-dod-range').addEventListener('click', function(e) {
    e.preventDefault();
    document.getElementById('form-group-dod-range').style.display = 'none';
    document.getElementById('form-group-dod-single').style.display = 'block';
    document.getElementById('dod_fieldset').value = 'single';
  });

  {% endif %}

  document.getElementById('clear-form').addEventListener('click', function(e) {
    e.preventDefault();
    const form = document.getElementById('advanced-search-form');
    form.reset();

    // Override fields with value attributes
    form.querySelectorAll('input').forEach(input => {
      input.value = '';
    });
    // Reset radio inputs
    form.querySelectorAll('input[type="radio"]').forEach(radio => {
      radio.checked = false;
    });

    // Reset checkboxes
    form.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
      checkbox.checked = false;
    });

    // Clear the result display
    document.getElementById('formattedDate-single-3').textContent = 'Type or paste in any format';
    document.getElementById('formattedDate-single-3').classList.remove('valid-date');
    document.getElementById('formattedDate-range-3').textContent = 'Type or paste in any format';
    document.getElementById('formattedDate-range-3').classList.remove('valid-date');
    document.getElementById('formattedAge-range-3').textContent = 'Type or paste in any format';
    document.getElementById('formattedAge-range-3').classList.remove('valid-date');
    document.getElementById('formattedDateOfDeath-single-3').textContent = 'Type or paste in any format';
    document.getElementById('formattedDateOfDeath-single-3').classList.remove('valid-date');
    document.getElementById('formattedDateOfDeath-range-3').textContent = 'Enter or paste a date in any format';
    document.getElementById('formattedDateOfDeath-range-3').classList.remove('valid-date');

    {% if data['version'] === '3' %}
    document.getElementById('advanced-search-form-surname').focus();
    {% endif %}
  });

  // when returning from the search results page the values autopopulate but the dynamic text needs updating to reflect what is in there
  {% if refine === 'true' %}

    if (document.getElementById('dob-single-3').value.trim() !== "") {
      console.log('refresh dynamic text for single dob field');
      updateDOBSingle()
    }

    if (document.getElementById('dob-range-3-from').value.trim() !== "") {
      console.log('refresh dynamic text for date range dob field');
      updateDOBRange();
    }

    if (document.getElementById('age-from').value.trim() !== "") {
      console.log('refresh dynamic text for age range dob field');
      updateAgeRange();
    }

    if (document.getElementById('dod-single-3').value.trim() !== "") {
      console.log('refresh dynamic text for single dod field');
    }

    if (document.getElementById('dod-range-3-from').value.trim() !== "") {
      console.log('refresh dynamic text for date range dod field');
      updateDODRange();
    }

    // automatically show and hide stuff to replicate how the search form was when submitted

    {% if data['dob_fieldset'] === 'date-range' %}
      document.getElementById('form-group-single-3').style.display = 'none';
      document.getElementById('form-group-date-range-3').style.display = 'block';
      document.getElementById('dob_fieldset').value = 'date-range';
    {% elif data['dob_fieldset'] === 'age-range' %}
      document.getElementById('form-group-single-3').style.display = 'none';
      document.getElementById('form-group-age-range-3').style.display = 'block';
      document.getElementById('dob_fieldset').value = 'age-range';
    {% endif %}

    {% if data['dod_fieldset'] === 'date-range' %}
      document.getElementById('form-group-dod-single').style.display = 'none';
      document.getElementById('form-group-dod-range').style.display = 'block';
      document.getElementById('dod_fieldset').value = 'date-range';
    {% endif %}

  {% endif %}

</script>
{% endblock %}